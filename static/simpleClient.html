<!DOCTYPE HTML>
<html>
<head>
    <title>Simple client for simple node server</title>
    <script src="jquery-1.8.2.min.js"></script>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="Accelerometer.js"></script>
</head>
<body>
    <h3 id="txtmsg"></h3>
    message: <input id="messageText" type="text" />
    <br>
    <button id="setButton">set</button>
    <form id="login" action="/login" method="post">
        <div>
            <label>Username:</label>
            <input type="text" name="username"/>
        </div>
        <div>
            <label>Password:</label>
            <input type="password" name="password"/>
        </div>
        <div>
            <input type="submit" value="Log In"/>
        </div>
    </form>

    <script>
        function callCmd(cmd, args, onSuccessFn, onErrFn) {
            var request = new XMLHttpRequest();
            var isAsynchronous = true;
            var url = "/json/" + cmd;
            var separator = "?";
            for (var key in args) {
                url += separator;
                url += key + "=" + args[key];
                separator = "&";
            }
            request.open("POST", url, isAsynchronous); //gets are cached
            request.onload = function(xmlEvent) {
                var responseObject = JSON.parse(request.response);
                if ("err" in responseObject) {
                    console.log(responseObject.err);
                    onErrFn(responseObject.err);
                }
                else {
                    onSuccessFn(responseObject.result);
                }
            };
            request.send();
        }
    </script>
    
    <script>
    
        function hasSessionCookie(){
            return getUserId() !== 'none';
        }

        function getUser() {
            var cookieArray = document.cookie.split(';');
            var cookies = {};
            for (var i = 0; i < cookieArray.length; i++){
                var parts = cookieArray[i].split('=');
                var key = parts[0].trim();
                var value = parts[1];
                cookies[key] = value;
            }
            //user will be an id if they're logged in
            return cookies;
        }

        function getUserId() {
            return getUser()['user'];
        }

        function getUserName() {
            return getUser()['name'];
        }

        $(document).ready(function() {

            if (hasSessionCookie()){
                document.getElementById('login').style.display = 'none';

                $('#txtmsg').text(getUserName());

                var socket = io.connect('http://localhost:3000/');
                
                socket.on('receive', function(data) {
                    console.log(data);
                });

                var sessId = getUserId();
                var userName = getUserName();

                $('#setButton').click(function(e) {
                    e.preventDefault();
                    // emit to the server the "send" event, with our data object
                    socket.emit('send', {player: userName, sessId: sessId, velocity:$('#messageText').val()});
                    
                    $('#messageText').val('');
                });
            }

            
        });
    </script>

</body>
</html>
